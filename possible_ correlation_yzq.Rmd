---
title: "Possible correlation"
author: "Zhongqi Yue"
date: "11/15/2020"
output: html_document
---


```{r}
library(tidyverse)
library(plotly)
```

Import data and filter the year 2016
```{r}
hotel_df = 
  read.csv("./data/hotel_bookings.csv") %>%
  filter(arrival_date_year == "2016") %>%
  mutate(is_canceled = as.factor(is_canceled))
```



#### Room type difference and cancellation

To see if the difference between the reserved room type and assigned room type could be a reason for cancellation.
```{r}
room_type_df=
  hotel_df %>%
  select(hotel, is_canceled, reserved_room_type, assigned_room_type) %>% 
  mutate(
    room_type_difference = case_when(
      reserved_room_type == assigned_room_type ~ "NO",
      reserved_room_type != assigned_room_type ~ "YES"
      ),
    is_canceled = recode(is_canceled, "1" = "Canceled", "0" = "Not Canceled")
  ) 

room_type_df%>%
  count(is_canceled, room_type_difference)%>% 
  plot_ly(
    x = ~room_type_difference, y = ~n,
    type = "bar", color = ~is_canceled, colors = "viridis"
  ) %>%
  layout(title = "The distribution of cancelation with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type")
  )

# To see the proportion of the cancellation within each group.
prop_df = 
  room_type_df %>% 
  group_by(room_type_difference) %>% 
  summarize(
    guest_total = n(),
    guest_canceled = sum(is_canceled == "Canceled")
  )

result_df = 
  prop_df %>% 
  mutate(
    prop_tests = map2(.x = guest_canceled, .y = guest_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(room_type_difference, estimate, conf.low, conf.high)

result_df %>% 
  plot_ly(
    x = ~room_type_difference, y = ~estimate,
    type = "bar", color = ~room_type_difference, colors = "viridis"
  ) %>%
  layout(title = "The proportion of cancelation with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type")
  )

# To see difference conditions for two hotels.
resort_hotel_df = 
  room_type_df %>% 
  filter(hotel == "Resort Hotel") 

resort_hotel_plot = 
  resort_hotel_df %>%
  count(is_canceled, room_type_difference) %>% 
  plot_ly(
    x = ~room_type_difference, y = ~n,
    type = "bar", color = ~is_canceled, colors = "viridis"
  ) %>%
  layout(title = "Resort Hotel cancellation distribution with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type")
  )

city_hotel_df = 
  room_type_df %>%
  filter(hotel == "City Hotel") 

city_hotel_plot = 
  city_hotel_df %>% 
  count(is_canceled, room_type_difference) %>% 
  plot_ly(
    x = ~room_type_difference, y = ~n,
    type = "bar", color = ~is_canceled, colors = "viridis"
  ) %>% 
  layout(title = "City Hotel cancellation distribution with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type")
  )

## To see the proportion of the cancellation within each group.
resort_prop_df = 
  resort_hotel_df %>% 
  group_by(room_type_difference) %>% 
  summarize(
    guest_total = n(),
    guest_canceled = sum(is_canceled == "Canceled")
  )

resort_result_df = 
  resort_prop_df %>% 
  mutate(
    prop_tests = map2(.x = guest_canceled, .y = guest_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(room_type_difference, estimate, conf.low, conf.high)

resort_prop_plot = 
  resort_result_df %>% 
  plot_ly(
    x = ~room_type_difference, y = ~estimate,
    type = "bar", color = ~room_type_difference, colors = "viridis"
  ) %>%
  layout(title = "The proportion of Resort Hotel's cancelation with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type")
  )
  
resort_prop_plot

city_prop_df = 
  city_hotel_df %>% 
  group_by(room_type_difference) %>% 
  summarize(
    guest_total = n(),
    guest_canceled = sum(is_canceled == "Canceled")
  )

city_result_df = 
  city_prop_df %>% 
  mutate(
    prop_tests = map2(.x = guest_canceled, .y = guest_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(room_type_difference, estimate, conf.low, conf.high)

city_prop_plot = 
  city_result_df %>% 
  plot_ly(
    x = ~room_type_difference, y = ~estimate,
    type = "bar", color = ~room_type_difference, colors = "viridis"
  ) %>%
  layout(title = "The proportion of City Hotel's cancelation with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type")
  )

city_prop_plot

# Combine two plots.
subplot(resort_prop_plot %>% layout(title = "Resort Hotel"), 
        city_prop_plot %>% layout(title = "City Hotel"),
        nrows = 2, shareX = TRUE) %>% 
  layout(title = "Cancellation proportion with room type difference",
         xaxis = list(title = "Difference between reserved and assigned room type"),
         yaxis = list(title = "Estimate")
  )
```

* The cancellation proportion is observed to be higher in "No room tpye difference" group in both hotels. 

#### Distribution channel and cancellation.
```{r}
# Distribution channel for two hotels.
hotel_df %>% 
  count(hotel, distribution_channel) %>% 
  mutate(distribution_channel = fct_reorder(distribution_channel, n)) %>% 
   plot_ly(x = ~distribution_channel, y = ~n, color = ~hotel,
           type = "bar",colors = "viridis"
          ) %>% 
   layout(title = "Distribution channel of two hotel",
         xaxis = list(title = "Distribution channel")
  )

# Cancellation distribution with distribution channel.
channel_df = 
  hotel_df %>% 
  mutate(is_canceled = recode(is_canceled, "1" = "Canceled", "0" = "Not Canceled")) %>% 
  select(hotel, is_canceled, distribution_channel)

channel_df %>% 
  count(hotel, is_canceled, distribution_channel) %>% 
  mutate(text_label = str_c("Hotel:", hotel ),
         distribution_channel = fct_reorder(distribution_channel, n)) %>% 
  plot_ly(x = ~distribution_channel, y = ~n, color = ~is_canceled,
          text = ~text_label, type = "bar",colors = "viridis"
          ) %>% 
   layout(title = "Cancellation distribution with distribution channel",
         xaxis = list(title = "Distribution Channel")
  )

# To see the proportion of the cancellation within each group.
channel_prop_df = 
  channel_df %>% 
  group_by(distribution_channel) %>% 
  summarize(
    guest_total = n(),
    guest_canceled = sum(is_canceled == "Canceled")
  )

channel_result_df = 
  channel_prop_df %>% 
  mutate(
    prop_tests = map2(.x = guest_canceled, .y = guest_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(distribution_channel, estimate, conf.low, conf.high)

channel_prop_plot = 
  channel_result_df %>% 
  mutate(distribution_channel = fct_reorder(distribution_channel, estimate)) %>% 
  plot_ly(
    x = ~distribution_channel, y = ~estimate,
    type = "bar", color = ~distribution_channel, colors = "viridis"
  ) %>%
  layout(title = "The proportion of cancelation with distribution channels",
         xaxis = list(title = "Distribution Channel")
  )
  
channel_prop_plot
```

* The cancellation proportion is observed to be highest in "TA/TO" booking channel.

#### Cancellation for hotels: weekday vs. weekend
```{r}
hotel_df %>% 
  select(hotel, is_canceled, stays_in_week_nights, stays_in_weekend_nights) %>%  
   mutate(text_label = str_c("Hotel:", hotel ) )%>% 
   plot_ly(x = ~stays_in_weekend_nights, y = ~stays_in_week_nights, color = ~is_canceled,
          text = ~text_label, type = "scatter",colors = "viridis", mode = "markers"
          ) 
```

* Currently no meaningful correlation is observed.

#### Cancellation and Repeated guest
```{r}
hotel_df %>% 
  select(hotel, is_canceled, is_repeated_guest) %>%
  mutate(is_canceled = recode(is_canceled, "1" = "Canceled", "0" = "Not Canceled"),
         is_repeated_guest = recode(is_repeated_guest, "1" = "Repeated Guest", "0" = "Not Repeated Guest")) %>%   
  count(is_repeated_guest, is_canceled ) %>% 
  plot_ly(x = ~is_repeated_guest, y = ~n, color = ~is_canceled,
          type = "bar",colors = "viridis"
          ) %>% 
  layout(title = "Cancellation distribution with repeat guest")

# To see the proportion of the cancellation within each group.
repeated_df = 
  hotel_df %>% 
  select(hotel, is_canceled, is_repeated_guest) %>%
  mutate(is_canceled = recode(is_canceled, "1" = "Canceled", "0" = "Not Canceled"),
         is_repeated_guest = recode(is_repeated_guest, "1" = "Repeated Guest", "0" = "Not Repeated Guest"))

repeated_prop_df = 
  repeated_df %>% 
  group_by(is_repeated_guest) %>% 
  summarize(
    guest_total = n(),
    guest_canceled = sum(is_canceled == "Canceled")
  )

repeated_result_df = 
  repeated_prop_df %>% 
  mutate(
    prop_tests = map2(.x = guest_canceled, .y = guest_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(is_repeated_guest, estimate, conf.low, conf.high)

repeated_prop_plot = 
  repeated_result_df %>% 
  plot_ly(
    x = ~is_repeated_guest, y = ~estimate,
    type = "bar", color = ~is_repeated_guest, colors = "viridis"
  ) %>%
  layout(title = "The proportion of cancelation with repeated guest",
         xaxis = list(title = "Repeated Guest")
  )

repeated_prop_plot
```

* Higher cancellation proportion is observed in "Not repeated guest" group.

#### Cancellation and Meal
```{r}
hotel_df %>% 
  select(hotel, is_canceled, meal) %>%
  mutate(is_canceled = recode(is_canceled, "1" = "Canceled", "0" = "Not Canceled")) %>% 
  count(meal, is_canceled) %>% 
  mutate(meal = fct_reorder(meal, n)) %>% 
  plot_ly(x = ~meal, y = ~n, color = ~is_canceled,
          type = "bar",colors = "viridis"
          )%>% 
   layout(title = "Cancellation distribution with meal type",
         xaxis = list(title = "Meal Type")
  )

# To see the proportion of the cancellation within each group.
meal_df = 
  hotel_df %>% 
  select(hotel, is_canceled, meal) %>%
  mutate(is_canceled = recode(is_canceled, "1" = "Canceled", "0" = "Not Canceled"))

meal_prop_df = 
  meal_df %>% 
  group_by(meal) %>% 
  summarize(
    guest_total = n(),
    guest_canceled = sum(is_canceled == "Canceled")
  )

meal_result_df = 
  meal_prop_df %>% 
  mutate(
    prop_tests = map2(.x = guest_canceled, .y = guest_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(meal, estimate, conf.low, conf.high)

meal_prop_plot = 
  meal_result_df %>% 
  mutate(meal = fct_reorder(meal, estimate)) %>% 
  plot_ly(
    x = ~meal, y = ~estimate,
    type = "bar", color = ~meal, colors = "viridis"
  ) %>%
  layout(title = "The proportion of cancelation with meal type",
         xaxis = list(title = "Meal Type")
  )

meal_prop_plot
```

* The cancellation proportion is observed to be highest in "FB" meal type.