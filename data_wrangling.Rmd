---
title: "data_wrangling"
author: "Bin Yang"
date: "11/11/2020"
output: html_document
---

```{r setup}
library(tidyverse)
library(tidymodels)
library(plotly)
library(viridis)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

#### EDA
Summary of the dataset:  

```{r}
hotel_df = 
  read.csv("./data/hotel_bookings.csv",na = c("", "NA", "NULL")) %>% 
  mutate_if(is.character, as.factor)
```
  

  
produce summary tables for categorical variables:  

```{r}
# skimr::skim(hotel_df)
# hotel_df %>% 
#   select(which(sapply(.,is.character))) %>% 
#   gtsummary::tbl_summary(by = hotel)
```

Possible plotly plots! (will edit labels etc. later)

Booking and cancellation by month:   I think color is pretty awful rn......

Bar plot:  
```{r}
hotel_df %>% 
  select(arrival_date_month, is_canceled) %>% 
  mutate(arrival_date_month = as.factor(arrival_date_month),
         is_canceled = as.factor(is_canceled)) %>% 
  count(arrival_date_month, is_canceled) %>% 
  mutate(arrival_date_month = fct_reorder(arrival_date_month, n)) %>% 
  plot_ly(x = ~arrival_date_month, y = ~ n, color = ~is_canceled, type ="bar", colors = "viridis")
  
```

Does the hotel charged differently for different customer type?   

need to do: modify axies, deal with outliers! 

boxplot:   
```{r}
hotel_df %>% 
  select(hotel, customer_type, adr) %>% 
  mutate(hotel= as.factor(hotel), 
         customer_type = as.factor(customer_type),
         customer_type = fct_reorder(customer_type, adr))%>%
  plot_ly(y = ~adr, x = ~customer_type, color = ~hotel, type ="box" , colors = "viridis") %>% 
  layout(boxmode = "group", yaxis = list(range=c(0,800)))
```

Home country of guests! 

a lot to improve... hover etc...
choropleth maps:  
```{r}
hotel_df %>% 
  select(country, is_canceled) %>% 
  filter(is_canceled == 0) %>% 
  group_by(country) %>% 
  summarise(
    total_booking = n(),
  ) %>% 
  mutate(
    booking_percent = round(total_booking/sum(total_booking)*100, 2)
  ) %>% 
  plot_ly(locations = ~country, z = ~booking_percent, type ="choropleth",
          colorscale="Viridis", zmin = 0, zmax = 30)
```

#### Modeling:    

data preprocessing:  

total NAs:  
```{r}
table_NA=
  hotel_df %>% 
  summarise_all(funs(sum(is.na(.))))

t(table_NA) %>% 
  knitr::kable()
```

```{r}
hotel_ml = 
  hotel_df %>% 
  mutate(
    arrival_season = case_when(
      arrival_date_month %in% c("October","November","December") ~ "Fall",
      arrival_date_month %in% c("January","February","March") ~ "Winter",
      arrival_date_month %in% c("April","May","June") ~ "Spring",
      TRUE ~ "Summer"
    ),
    arrival_season = as.factor(arrival_season),
    reserved_room_type = as.character(reserved_room_type),
    assigned_room_type = as.character(assigned_room_type),
    false_room_assignment = case_when(
      reserved_room_type == assigned_room_type ~ "0",
      reserved_room_type != assigned_room_type ~ "1"
    ),
    false_room_assignment = as.factor(false_room_assignment),
    is_canceled = as.factor(is_canceled)) %>% 
    select(-c(arrival_date_year, arrival_date_week_number, arrival_date_day_of_month,
              arrival_date_month, reservation_status_date, reservation_status, 
              agent, company, country, reserved_room_type, assigned_room_type)) 
```


train/test split:  
```{r}
set.seed(123)
hotel_split = initial_split(hotel_ml)
```


